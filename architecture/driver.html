
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>CC-Fabric ML2 Driver Internals &#8212; networking-ccloud 0.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/basic.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Device Config" href="switch-config.html" />
    <link rel="prev" title="Overview" href="overview.html" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Bootstrap CSS -->
<link href="../_static/css/bootstrap.min.css" rel="stylesheet">

<!-- Fonts -->
<link href="../_static/css/font-awesome.min.css" rel="stylesheet">

<!-- Custom CSS -->
<link href="../_static/css/combined.css" rel="stylesheet">

<!-- Search CSS -->
<link href="../_static/css/search.css" rel="stylesheet">

<!-- Pygments CSS -->
<link href="../_static/pygments.css" rel="stylesheet">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-17511903-1', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->


  </head><body>
<style>
    body {
        margin: 0;
        display: flex;
        flex-direction: column;
    }

    .juno-pageheader {
        display: flex;
        align-items: center;
        background: rgb(0,8,16);
        position: sticky;
        top: 0;
        padding: 12px 24px;
    }

    .sap-logo {
        height: 24px;
        margin-right: 12px;
    }

    .header-title {
        color: rgb(222,223,224);
        font-family: Arial;
        font-size: 18px;
        line-height: 24px;
    }

    /* class from doc layout -- main container */
    .docs-book-wrapper {
        flex-grow: 1;
        margin-top: 16px;
    }
</style>

<div class="juno-pageheader" role="banner">
    <img src="../_static/images/sap_logo.svg" alt="SAP Logo" class="sap-logo" />
    <div class="header-title">Converged Cloud | networking-ccloud</div>
</div>

    <div class="container docs-book-wrapper">
      <div class="row">
        <div class="col-lg-9 col-md-8 col-sm-8 col-lg-push-3 col-md-push-4 col-sm-push-4">
<div class="row docs-title">
  <div class="col-lg-8">
      <h1>CC-Fabric ML2 Driver Internals</h1>
    
  </div>
  <div class="docs-actions">
    
    <a href="overview.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Overview"></i></a>
    
    
    <a href="switch-config.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Device Config"></i></a>
    
  </div>
</div>
          <div class="row">
            <div class="col-lg-12">
              <div class="docs-body" role="main">

  <section id="cc-fabric-ml2-driver-internals">
<h1>CC-Fabric ML2 Driver Internals<a class="headerlink" href="#cc-fabric-ml2-driver-internals" title="Permalink to this heading">¶</a></h1>
<p>NOTE: these are currently drafts and thoughts that have been recorded over the course of the project.
Some have been written before implementation, some while implementation was being done. Therefore they
might not be 100% accurate or need a review.</p>
<section id="structural-overview">
<h2>Structural Overview<a class="headerlink" href="#structural-overview" title="Permalink to this heading">¶</a></h2>
</section>
<section id="db-api-and-config-objects-how-they-match-together">
<h2>DB, API and Config Objects &amp; How They Match Together<a class="headerlink" href="#db-api-and-config-objects-how-they-match-together" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt>The following API objects are relevant for a network configuration:</dt><dd><ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">network</span></code></dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code> - used as name / reference for this network</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">availability_zone_hints</span></code> - used to decide if a port can be bound in this network</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">admin_state_up</span></code> - <strong>FIXME</strong> should we respect this flag?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">router:external</span></code> - external or internal network</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">subnet</span></code> - belongs to a single network, only relevant for external networks</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">gateway_ip</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">port</span></code></dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">binding_host</span></code> - host, which will be mapped to a hostgroup by the driver</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">binding_profile</span></code> - alternative source for binding host (used by baremetal)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">admin_state_up</span></code> - <strong>FIXME</strong> should we respect this flag?</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
<dt>The following DB tables are relevant:</dt><dd><ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">networksegments</span></code></dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">network_type</span></code> - vxlan or vlan; the driver will only manage vlan segments (vxlan segments are managed by neutron, not us)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">network_id</span></code> - network_id this segment is relevant for</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">physical_network</span></code> - name of the physnet (as defined by hostgroup in driver config)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">segmentation_id</span></code> - vni or vlan id</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">segment_index</span></code> - level of segment, 0 is the top level vxlan segment, 1+ driver managed</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">ml2_port_bindings</span></code></dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">host</span></code> - binding_host, see port</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">profile</span></code> - binding_profile, see port</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vif_details</span></code> - driver-internal extras</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">ml2_port_binding_levels</span></code></dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">driver</span></code> - for each port bound by the driver there has to be a level 0 entry</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">host</span></code> - binding_host, again (isn’t this a duplicate?)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
<dt>In our driver-config we have:</dt><dd><ul class="simple">
<li><dl class="simple">
<dt>Hostgroup - maps binding_hosts to vlan pool / physical_network name</dt><dd><ul>
<li><p>NOTE: multiple Hostgroups can reference the same physnet_name</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Host - defines list of interfaces on switches that need to be bound</p></li>
</ul>
</dd>
</dl>
<p>A network consists of multiple networksegments, which hold the vlan and the physical network in question.
Ports are bound to segments and hold a binding_host as well, which should match a host in our config
(else we cannot bind the port).</p>
<dl class="simple">
<dt>So to generate a full config for a network we need to look at the following things:</dt><dd><ul class="simple">
<li><dl class="simple">
<dt>all binding_hosts in a network specify which ports are bound to a network</dt><dd><ul>
<li><p>all binding_hosts can be found by querying all ports for a network</p></li>
<li><p>the networksegment they’re bound to carry the vlan id we need to use</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</section>
<section id="sync-operations">
<h2>Sync Operations<a class="headerlink" href="#sync-operations" title="Permalink to this heading">¶</a></h2>
<dl class="simple">
<dt>There are three sync operations the driver is using:</dt><dd><ul class="simple">
<li><p>hostgroup-network-sync - sync for a single hostgroupin one network on all switches, used on port bind or port delete</p></li>
<li><p>network-sync - sync all hostgroups for a single network on all switches</p></li>
<li><p>switch-sync - snyc all networks on a single switch</p></li>
</ul>
</dd>
<dt>hostgroup-network-sync bind:</dt><dd><ul class="simple">
<li><p>get hostgroup of binding_host</p></li>
<li><p>find (or create) matching segment</p></li>
<li><p>sync this networksegment to all switches that have interfaces in the hostgroup</p></li>
</ul>
</dd>
<dt>hosgroup-network-sync delete:</dt><dd><ul class="simple">
<li><p>get hostgroup of binding_host</p></li>
<li><p>check if any ports with the same binding_host remain. if so, stop</p></li>
<li><dl class="simple">
<dt>check if any other binding_hosts are using the same interface. if all interfaces are still in use, stop</dt><dd><ul>
<li><p>FIXME: maybe we can check only hosts on the same networksegment?</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>rpc call: remove vlan from all unused interfaces</p></li>
<li><p>find matching network segment</p></li>
<li><p>if no host in current network binds this segment, remove it from DB</p></li>
</ul>
</dd>
<dt>network-sync:</dt><dd><ul class="simple">
<li><p>get all binding_hosts for this network</p></li>
<li><p>get all hostgroups from binding_hosts, generate config with help of segments</p></li>
<li><p>…</p></li>
</ul>
</dd>
<dt>switch-sync:</dt><dd><ul class="simple">
<li><p>get all physical_networks that could be on the switch to sync</p></li>
<li><p>query all networksegments with these physical_networks</p></li>
<li><p>get all ports bound by the driver for this on these segments</p></li>
<li><p>use this to get a list of binding hosts to generate the necessary config</p></li>
<li><p>send to agent, tell it that this is the complete list and other mappings can be cleaned</p></li>
</ul>
</dd>
</dl>
</section>
<section id="agent-design">
<h2>Agent Design<a class="headerlink" href="#agent-design" title="Permalink to this heading">¶</a></h2>
</section>
<section id="agent-communication">
<h2>Agent Communication<a class="headerlink" href="#agent-communication" title="Permalink to this heading">¶</a></h2>
<p>Operation: add, remove, replace</p>
<dl class="simple">
<dt>For communicating a change to an agent we need to include the following information per switch:</dt><dd><ul class="simple">
<li><p>switch identifier</p></li>
<li><dl class="simple">
<dt>list of vni mappins</dt><dd><ul>
<li><p>operation - add, remove, replace</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>list of local vlans</dt><dd><ul>
<li><p>operation - add, remove, replace</p></li>
<li><p>description (network uuid)</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>list of interfaces + their config</dt><dd><ul>
<li><p>vlans</p></li>
<li><p>vlan translations</p></li>
<li><p>port-channel id (optional)</p></li>
<li><p>member-interfaces for port-channel (optional)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
<p>Note: For a port-channel all subinterfaces will be overriden with the same config a the moment. An
alternative idea would be to only configure this interface in case of direct-on-fabric stuff, e.g.
native vlans.</p>
</section>
<section id="network-syncloop-in-agent">
<h2>Network Syncloop (in Agent)<a class="headerlink" href="#network-syncloop-in-agent" title="Permalink to this heading">¶</a></h2>
</section>
<section id="network-scheduling-on-borderleafs-and-aci-transits">
<h2>Network Scheduling on Borderleafs and ACI Transits<a class="headerlink" href="#network-scheduling-on-borderleafs-and-aci-transits" title="Permalink to this heading">¶</a></h2>
<p>Both Borderleafs and ACI Transit Switches have a maximum capacity of x VLANS (2000 on Arista, 1750 on ACI).</p>
</section>
<section id="in-driver-api-for-debugging-and-maintenance">
<h2>In-Driver API for Debugging and Maintenance<a class="headerlink" href="#in-driver-api-for-debugging-and-maintenance" title="Permalink to this heading">¶</a></h2>
<p>The In-Driver API is an API directly inside the driver using OpenStack authentication and other OpenStack facilities to
provide debug information and driver commands (sync a router, switch host-mode).</p>
<section id="network-related-actions">
<h3>Network-Related Actions<a class="headerlink" href="#network-related-actions" title="Permalink to this heading">¶</a></h3>
</section>
<section id="current-network-status">
<h3>Current Network Status<a class="headerlink" href="#current-network-status" title="Permalink to this heading">¶</a></h3>
<p>Show status of a given network, pulled from OpenStack DB, enrichted with driver-config knowledge. This will include
hostgroups bound to the network, on which leaf switches the network should be bound, etc. This is basically the same
data the driver hands out to its agents to sync a network.</p>
</section>
<section id="network-diff">
<h3>Network Diff<a class="headerlink" href="#network-diff" title="Permalink to this heading">¶</a></h3>
<p>Get the current network state and ask each agent for a diff. The agent will use the sync data to generate device config,
pull the current state off of the device and return a diff between those two. This will be returned to the API-user in a
per-device dictionary.</p>
</section>
<section id="network-sync">
<h3>Network Sync<a class="headerlink" href="#network-sync" title="Permalink to this heading">¶</a></h3>
<p>Tell the driver to reapply the network config to all leaf switches the network should be on. We MAY want to check other
switches for leftover config (check that the VNI is not configured on any device it should not be on), though this could
also be handled by a separate per-device cleanup loop.</p>
</section>
<section id="switch-leafpair-related-actions">
<h3>Switch / Leafpair Related Actions<a class="headerlink" href="#switch-leafpair-related-actions" title="Permalink to this heading">¶</a></h3>
<dl class="simple">
<dt>Currently in brainstorming phase:</dt><dd><ul class="simple">
<li><dl class="simple">
<dt>test connection</dt><dd><ul>
<li><p>dump version and uptime of all connected devices</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>resync all networks on a device</p></li>
</ul>
</dd>
</dl>
</section>
<section id="driver-related-actions">
<h3>Driver Related Actions<a class="headerlink" href="#driver-related-actions" title="Permalink to this heading">¶</a></h3>
<ul class="simple">
<li><dl class="simple">
<dt>show syncloop status</dt><dd><ul>
<li><p>pause syncloop</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>switch hostgroup state for avocado</p></li>
</ul>
</section>
</section>
</section>


              </div>
            </div>
          </div>
          <div class="docs-actions">
          
            <a href="overview.html"><i class="fa fa-angle-double-left" data-toggle="tooltip" data-placement="top" title="Previous: Overview"></i></a>
          
          
            <a href="switch-config.html"><i class="fa fa-angle-double-right" data-toggle="tooltip" data-placement="top" title="Next: Device Config"></i></a>
          
          </div>
          <div class="row docs-byline bottom">
            <div class="docs-updated">this page last updated: 2022-09-27 18:31:00</div>
          </div>
          <div class="row">
            <div class="col-lg-8 col-md-8 col-sm-8 docs-license">

            </div>
            <div class="col-lg-4 col-md-4 col-sm-4 docs-actions-wrapper">
            <!-- ID buglinkbottom added so that pre-filled doc bugs
                 are sent to Launchpad projects related to the
                 document -->
            </div>
          </div>
        </div>
<div class="col-lg-3 col-md-4 col-sm-4 col-lg-pull-9 col-md-pull-8 col-sm-pull-8 docs-sidebar">
  <div class="btn-group docs-sidebar-releases">
    <button onclick="location.href='/'" class="btn docs-sidebar-home" data-toggle="tooltip" data-placement="top" title="OpenStack Docs Home"><i class="fa fa-arrow-circle-o-left"></i></button>
<button href="#" type="button" class="btn docs-sidebar-release-select">SAP CCloud Fabric Documentation</button>
  </div>
  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="table-of-contents">
      <a href="../index.html" class="docs-sidebar-section-title"><h4>networking-ccloud 0.0.0</h4></a>
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Driver Architecutre</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">CC-Fabric ML2 Driver Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="switch-config.html">Device Config</a></li>
<li class="toctree-l2"><a class="reference internal" href="numerical-attributes.html">Numerical Attributes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../install/index.html">Networking CCloud VXLAN Fabric service installation guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributor/index.html">Contributor Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">Command line interface reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">References</a></li>
</ul>

    </div>

  <div class="docs-sidebar-toc">
    <div class="docs-sidebar-section" id="local-table-of-contents">
      <h4 class="docs-sidebar-section-title">Page Contents</h4>
      <ul>
<li><a class="reference internal" href="#">CC-Fabric ML2 Driver Internals</a><ul>
<li><a class="reference internal" href="#structural-overview">Structural Overview</a></li>
<li><a class="reference internal" href="#db-api-and-config-objects-how-they-match-together">DB, API and Config Objects &amp; How They Match Together</a></li>
<li><a class="reference internal" href="#sync-operations">Sync Operations</a></li>
<li><a class="reference internal" href="#agent-design">Agent Design</a></li>
<li><a class="reference internal" href="#agent-communication">Agent Communication</a></li>
<li><a class="reference internal" href="#network-syncloop-in-agent">Network Syncloop (in Agent)</a></li>
<li><a class="reference internal" href="#network-scheduling-on-borderleafs-and-aci-transits">Network Scheduling on Borderleafs and ACI Transits</a></li>
<li><a class="reference internal" href="#in-driver-api-for-debugging-and-maintenance">In-Driver API for Debugging and Maintenance</a><ul>
<li><a class="reference internal" href="#network-related-actions">Network-Related Actions</a></li>
<li><a class="reference internal" href="#current-network-status">Current Network Status</a></li>
<li><a class="reference internal" href="#network-diff">Network Diff</a></li>
<li><a class="reference internal" href="#network-sync">Network Sync</a></li>
<li><a class="reference internal" href="#switch-leafpair-related-actions">Switch / Leafpair Related Actions</a></li>
<li><a class="reference internal" href="#driver-related-actions">Driver Related Actions</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
  </div>
  </div>
</div>
      </div>
    </div>
<style>
    .juno-pagefooter {
        display: flex;
        position: relative;
        background: rgba(41, 47, 54, 1);
        min-height: 56px;
    }

    .ccloud-shape {
        height: 42px;
        position: absolute;
        right: 0;
        bottom: 0;
    }
</style>

<div class="juno-pagefooter" role="contentinfo">
    <img src="../_static/images/ccloud_shape.svg" alt="Converged Cloud cloud shape" class="ccloud-shape" />
</div>
<!-- jQuery -->
<script type="text/javascript" src="../_static/js/jquery-3.2.1.min.js"></script>

<!-- Bootstrap JavaScript -->
<script type="text/javascript" src="../_static/js/bootstrap.min.js"></script>

<!-- The rest of the JS -->
<script type="text/javascript" src="../_static/js/navigation.js"></script>

<!-- Docs JS -->
<script type="text/javascript" src="../_static/js/docs.js"></script>

<!-- standard sphinx include libraries, which allow search highlighting -->
<script type="text/javascript" src="../_static/underscore.js"></script>
<script type="text/javascript" src="../_static/doctools.js"></script>
<script type="text/javascript" src="../_static/searchtools.js"></script>
<script type="text/javascript" src="../_static/language_data.js"></script>

<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
      URL_ROOT:    './',
      VERSION:     '0.0.0',
      COLLAPSE_INDEX: false,
      FILE_SUFFIX: '.html',
      LINK_SUFFIX: '.html',
      SOURCELINK_SUFFIX: '.txt',
      HAS_SOURCE:  true
    };
</script>

<!-- Javascript for page -->
<script language="JavaScript">
  /* Build a description of this page including SHA, source location on git
   * repo, build time and the project's launchpad bug tag. Set the HREF of the
   * bug buttons
   */
</script>


<script type="text/javascript">
    $(document).ready(function(){

          $.ajax({
            context: this,
            dataType : "html",
            url : "https://docs.openstack.org/latest/badge.html",
            success : function(results) {
                $('#deprecated-badge-container').html(results);
            }
        });
    });
</script>
<div id="deprecated-badge-container"></div>

  </body>
</html>